# dojo-synthetic-api

This repository generates question & answer pairs (QAP), which are retrieved and assessed by [Dojo Subnet](https://github.com/tensorplex-labs/dojo).

In terms of implementation, an asynchronous task scheduler is used to schedule QAP generation. Redis is used to store generated pairs. Dojo retrieve QAPs by querying the `/synthetic-gen` endpoint hosted by this repo. Successful retrieval will delete that QAP from redis. When the number of stored pairs falls under a given threshold, the task scheduler will generate new QAPs to replenish the database, ensuring that there is always a healthy supply of QAPs for use by Dojo.

QAPs are generated by prompting and querying LLMs. This process is underimprovement and is subject to change in the future.

1. Query an LLM for a list of common objects used in animation.
2. Prompt an LLM with these objects to create a coding question.
3. Prompt an LLM to answer the generated question. The generated question and output code make up a QAP.

Currently, synthetic-api only generates code output as Javascript. We are in the process of expanding support for other programming languages.

## Setup

Before running the synthetic-api, you will need the following keys:

- Openrouter (from https://openrouter.ai/)

Copy the .env.example file to a .env file and fill in the blanks, here we will use Openrouter as our LLM API provider.

Docker will create a redis instance using the specified `REDIS_USERNAME` and `REDIS_PASSWORD`. You will need these to manually interact with your redis on docker.

```bash
cp .env.example .env

# env vars that need to be filled
REDIS_USERNAME=
REDIS_PASSWORD=
OPENROUTER_API_KEY=
```

## Run with docker-compose

Install docker and docker-compose:

```bash
sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
sudo mkdir -m 0755 -p /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

Run docker to launch synthetic-api:

```bash
# Run the service
docker compose up -d
```

# Code Executor

What actually goes on under the hood for us to get code execution feedback, syntax errors, import errors, type errors, etc.

1. Injects error logging code into a single index.html file which represents the code generated by the LLM.
2. Boots up a nodejs server to serve the `index.html` file at `localhost:3000`
3. Use playwright in headless mode to visit `localhost:3000` to trigger rendering of the page, where the error logging code will make requests to an endpoint defined inside of the nodejs server, `server.js`.
4. Creates a temporary folder called `run_<uuid>` , and writes any of the error logs received on the server side endpoint to a file called `run_<uuid>/app.log` inside of the `sandbox-workspace`
